---
title: "The Best NBA Players, According To Raptor"
subtitle: "FiveThirtyEight BST 270 Individual Project"
output: html_document
#date: "2024-01-14"
author: "Richa Jain"
---

## Project

This project attempts to reproduce the graph and table from FiveThirtyEight's [The Best NBA Players, According To RAPTOR](https://projects.fivethirtyeight.com/nba-player-ratings/)

## Load necessary packages

I used pacman for this as it cleans up code and installs and loads the needed packages.

```{r, message = FALSE, echo = FALSE}
# load relevant packages 
if (!require('pacman')) {
    install.packages('pacman')
} 
pacman::p_load('knitr', 'reactable', 'htmltools', 'RColorBrewer', 'DT', 'tidyverse', 'dplyr', 'plotly')
```

## Load data

The first step to reproducing the table and graph is to download the data. 
We use two datasets: one for RAPTOR information by player and one for RAPTOR information by team. 
Both datasets can be found on [FiveThirtyEight's GitHub](https://github.com/fivethirtyeight/data/tree/master/nba-raptor).
We use the datasets labeled at 'latest' for these figures. 

```{r, echo = FALSE}
#set wd:
setwd("/Users/richajain/Library/Mobile Documents/com~apple~CloudDocs/Harvard/Harvard Winter 2024/BST270/bst270-finalproject/bst270_finalproject")
#load data from dataset folder
latest_raptor_player <- read.csv("datasets/latest_RAPTOR_by_player.csv") 
latest_raptor_team <- read.csv("datasets/latest_RAPTOR_by_team.csv") 
```

## Data Wrangling

The datasets we loaded need to be joined together so the first step is to create the dataframe that we need to reproduce both of these figures by using a left join and selecting only the relevant variables. The article says that they included players who played in at least 70% of their team's games and averaged at least 24 minutes per game. There was no data on what percentage of games each player played in, so the filtering is slightly off and results in extra rows and extra data points. 

```{r, echo = FALSE}
nba <- latest_raptor_player %>% 
  left_join(select(latest_raptor_team, player_name, team), by = "player_name") %>% 
  distinct()
```

```{r, echo = FALSE}
nba_gen <- nba %>% 
  select(player_name, season, team, mp, raptor_box_offense, raptor_box_defense, raptor_box_total,
 raptor_onoff_offense, raptor_onoff_defense, raptor_onoff_total, 
 raptor_offense, raptor_defense, raptor_defense, raptor_total, war_total) %>% 
  filter(mp >= 1137) %>% 
  arrange(-war_total)
```


### Reproducibility Comment 

While perform basic data wrangling, I noticed that the table that FiveThirtyEight created has a column for player positions. However, the datasets provided do not contain information on what position each player played. This is something that would need to be manually researched and added in. Therefore, we can recreate much of the original table, but cannot add in this column. 

Additionally, there is data on the teams that each player played for; however, it is abbreviated, so to get the column to look like the article, I had to manually research and add in the unabbreviated version. The data does not contain the right information. 

Another issue that I faced was that FiveThirtyEight's figures are interactive. I, unfortunately, could not figure out how to make my reproduced figures as interactive, so I had a specific filter that I set everything to and recreated those figures. 

**Note: To reproduce this, please set FiveThirtyEight's filters to the following:**

1. Season: '22-'23
1. Season Type: Full Season
1. Minimum Minutes Played: 1137
1. Team: All Teams
1. Position: All Positions
1. Years of Experience: Any number

## Reproduce Table

### Comments on constructing the table

I used reactable to recreate the table shown in the article. I had to rename some of the columns, add in the unabbreviated version of the team names, and reformat the minutes played and season columns. 

```{r, echo = FALSE}
box_score_raptor <- c("raptor_box_offense", "raptor_box_defense", "raptor_box_total")
on_off_raptor <- c("raptor_onoff_offense", "raptor_onoff_defense", "raptor_onoff_total")
overall_raptor <- c("raptor_offense", "raptor_defense", "raptor_total", "war_total")

nba_gen <- nba_gen[, c("player_name", "season", "team", "mp", box_score_raptor, on_off_raptor, overall_raptor)]

cols_to_round <- c("raptor_box_offense", "raptor_box_defense", "raptor_box_total",
                    "raptor_onoff_offense", "raptor_onoff_defense", "raptor_onoff_total",
                    "raptor_offense", "raptor_defense", "raptor_total", "war_total")

for(i in cols_to_round){
  nba_gen[[i]] <- format(round(nba_gen[[i]], 1), nsmall = 1)
}
```

```{r, echo = FALSE}
#rename columns: 
nba_gen <- nba_gen %>% 
  rename(
    PLAYER = player_name,
    TEAM = team,
    MINUTES = mp,
  )

#have to find these on your own
TEAM <- c("ATL", "BOS", "BKN", "CHA", "CHI", "CLE", "DAL", "DEN", "DET",
          "GSW", "HOU", "IND", "LAC", "LAL", "MEM", "MIA", "MIL", "MIN",
          "NOP", "NYK", "OKC", "ORL", "PHI", "PHX", "POR", "SAC", "SAS",
          "TOR", "UTA", "WAS", "PHO", "BRK")
full_name <- c("Hawks", "Celtics", "Nets", "Hornets", "Bulls", "Cavaliers",
          "Mavericks", "Nuggets", "Pistons", "Warriors", "Rockets",
          "Pacers", "Clippers", "Lakers", "Grizzlies", "Heat", "Bucks",
          "Timberwolves", "Pelicans", "Knicks", "Thunder", "Magic",
          "76ers", "Suns", "Blazers", "Kings", "Spurs", "Raptors",
          "Jazz", "Wizards", "Suns", "Nets")

nba_teams <- data.frame(
  TEAM, full_name 
)

nba_gen <- nba_gen %>% 
  left_join(select(nba_teams, TEAM, full_name), by = "TEAM")

nba_gen <- nba_gen[, c("PLAYER", "season", "full_name", "MINUTES", box_score_raptor, on_off_raptor, overall_raptor)]
nba_gen <- nba_gen %>% 
  rename(
    TEAM = full_name
  )

nba_gen$MINUTES <- format(nba_gen$MINUTES,big.mark=", ", trim=TRUE)
nba_gen$season <- nba_gen$season %% 100
```

```{r, echo = FALSE}
#convert columns to numeric:
for(i in cols_to_round){
  nba_gen[[i]] <- as.numeric(nba_gen[[i]])
}
```

```{r, echo = FALSE}
blue_pal <- function(x) rgb(colorRamp(c("#fa8072", "white", "#35b0ab"))(x), maxColorValue = 255)

table <- reactable(
  nba_gen,
  columns = list(
    PLAYER = colDef(
      cell = function(value, index) {
        #season <- nba_gen$season[index]
        div(
          class = "player",
          div(
            span(class = "player", value),
            span(class = "season", sprintf(" '22-'%s", nba_gen[index, "season"]),
                 style = list(fontSize = "0.75rem"))
            #div(style = list(fontSize = "0.75rem"), season)
          )
        )
      }
    ),
    season = colDef(show = FALSE),
    
      raptor_offense = colDef(style = function(value) {
      normalized <- (value - min(nba_gen$raptor_offense)) / (max(nba_gen$raptor_offense) - min(nba_gen$raptor_offense))
      color <- blue_pal(normalized)
      list(background = color)
      },
      name = "OFF.",
      cell = function(value) {
        if (value >= 0) paste0("+", value) else value
      },
      headerStyle = list(fontWeight = "100",
                         fontSize = "0.75rem")),
      
      raptor_defense = colDef(style = function(value) {
      normalized <- (value - min(nba_gen$raptor_defense)) / (max(nba_gen$raptor_defense) - min(nba_gen$raptor_defense))
      color <- blue_pal(normalized)
      list(background = color)
      },
      name = "DEF.",
      cell = function(value) {
        if (value >= 0) paste0("+", value) else value
      },
      headerStyle = list(fontWeight = "100",
                         fontSize = "0.75rem")),
      
      raptor_total = colDef(style = function(value) {
      normalized <- (value - min(nba_gen$raptor_total)) / (max(nba_gen$raptor_total) - min(nba_gen$raptor_total))
      color <- blue_pal(normalized)
      list(background = color)
      
      },
      name = "TOT.",
      cell = function(value) {
        if (value >= 0) paste0("+", value) else value
      },
      headerStyle = list(fontWeight = "100",
                         fontSize = "0.75rem")),
      
      raptor_box_offense = colDef(
      cell = function(value) {
        if (value >= 0) paste0("+", value) else value
      },
      name = "OFF.",
      headerStyle = list(fontWeight = "100",
                         fontSize = "0.75rem")),
      
      raptor_box_defense = colDef(
      cell = function(value) {
        if (value >= 0) paste0("+", value) else value
      },
      name = "DEF.",
      headerStyle = list(fontWeight = "100",
                         fontSize = "0.75rem")),
      
      raptor_box_total = colDef(
      cell = function(value) {
        if (value >= 0) paste0("+", value) else value
      },
      name = "TOT.",
      headerStyle = list(fontWeight = "100",
                         fontSize = "0.75rem")),
      
      raptor_onoff_offense = colDef(
      cell = function(value) {
        if (value >= 0) paste0("+", value) else value
      },
      name = "OFF.",
      headerStyle = list(fontWeight = "100",
                         fontSize = "0.75rem")),
      
      raptor_onoff_defense = colDef(
      cell = function(value) {
        if (value >= 0) paste0("+", value) else value
      },
      name = "DEF.",
      headerStyle = list(fontWeight = "100",
                         fontSize = "0.75rem")),
      
      raptor_onoff_total = colDef(
      cell = function(value) {
        if (value >= 0) paste0("+", value) else value
      },
      name = "TOT.",
      headerStyle = list(fontWeight = "100",
                         fontSize = "0.75rem")),
      
      war_total = colDef(name = "WAR",
                         headerStyle = list(background = "darkgrey",
                                            color = "white",
                                            fontWeight = "700",
                                            fontSize = "0.75rem"),
                         style = function(value, index, name){
                            list(fontWeight = "bold")
                         }
                         )
  ),
  columnGroups = list(
    colGroup(name = "BOX SCORE RAPTOR", columns = box_score_raptor, headerStyle = list(fontSize = "0.75rem")),
    colGroup(name = "ON/OFF RAPTOR", columns = on_off_raptor, headerStyle = list(fontSize = "0.75rem")),
    colGroup(name = "OVERALL RAPTOR", columns = overall_raptor, headerStyle = list(fontSize = "0.75rem"))
  ),
  rownames = TRUE,
  defaultColDef = colDef(headerStyle = list(fontSize = "0.75rem")),
  defaultPageSize = 300,
  width = 800
)
table
```

### Some Notes (Table)

1. Make sure to swipe to see all the columns. 
2. Rounding and some formatting is a bit off due to my lack of experience using reactable. 
4. Number of rows does not match possibly due to lack of information on filtering for 70% of games played. 

## Reproduce Scatterplot

### Comments on constructing the scatterplot

For this I used the plotly library and I used the dataset I constructed for the table above. 

```{r, echo = FALSE}
fig <- nba_gen %>% 
  plot_ly(x = ~raptor_offense, y = ~raptor_defense, text = ~paste(PLAYER, " '22-'", season, " ", TEAM,
                                                                  " \n", "Offensive RAPTOR: ", raptor_offense,
                                                                  " \n", "Defensive RAPTOR: ", raptor_defense),
          type = "scatter", mode = "markers") %>% 
  layout(#annotations = list(text = "- offense", x = -9, y = 9, showarrow = FALSE, fill = "pink",
        #                    text = "+ defense", x = -9, y = 8, showarrow = FALSE),
         title = "Where every player in the NBA stands, according to RAPTOR",
         xaxis = list(title = "Offensive RAPTOR rating",
                      range = c(-11, 11),
                      ticktext = list("-10", "-5", "0", "+5", "+10"), 
                      tickvals = list(-10, -5, 0, 5, 10),
                      zerolinecolor = "lightgrey",
                      gridcolor = "lightgrey"),
         yaxis = list(title = "Defensive RAPTOR rating",
                      range = c(-11, 11),
                      ticktext = list("-10", "-5", "0", "+5", "+10"), 
                      tickvals = list(-10, -5, 0, 5, 10),
                      zerolinecolor = "lightgrey",
                      gridcolor = "lightgrey")) 
fig <- fig %>% add_annotations(
  x = -9,
  y = 9,
  text = "- offense",
  showarrow = FALSE,
  bgcolor = "pink"
)
fig <- fig %>% add_annotations(
  x = -9,
  y = 8,
  text = "+ defense",
  showarrow = FALSE,
  bgcolor = "lightblue"
)
fig <- fig %>% add_annotations(
  x = 9,
  y = 9,
  text = "+ offense",
  showarrow = FALSE,
  bgcolor = "lightblue"
)
fig <- fig %>% add_annotations(
  x = 9,
  y = 8,
  text = "+ defense",
  showarrow = FALSE,
  bgcolor = "lightblue"
)
fig <- fig %>% add_annotations(
  x = -9,
  y = -8,
  text = "- offense",
  showarrow = FALSE,
  bgcolor = "pink"
)
fig <- fig %>% add_annotations(
  x = -9,
  y = -9,
  text = "- defense",
  showarrow = FALSE,
  bgcolor = "pink"
)
fig <- fig %>% add_annotations(
  x = 9,
  y = -8,
  text = "+ offense",
  showarrow = FALSE,
  bgcolor = "lightblue"
)
fig <- fig %>% add_annotations(
  x = 9,
  y = -9,
  text = "- defense",
  showarrow = FALSE,
  bgcolor = "pink"
)
fig <- fig %>% 
  add_trace(
    marker = list(
      color = "white",
      size = 10,
      line = list(
        color = "black",
        width = 1.5
      )
  )) 
fig <- fig %>% layout(showlegend = FALSE)
#top right:
fig <- fig %>% layout(
  shapes = list(
    list(
      type = "rect",
      x0 = 0,
      y0 = 0,
      x1 = 10,
      y1 = 10,
      fillcolor = "rgba(173, 216, 230, 0.5)",  
      line = list(
      width = 0
      )
    ),
    list(
      type = "rect",
      x0 = -10,
      y0 = -10,
      x1 = 0,
      y1 = 0,
      fillcolor = "rgba(255, 0, 0, 0.2)", 
      line = list(
      width = 0
      )
    )
  )
)
  
fig
```

### Some Notes (Scatterplot)

1. Again, some of the formatting is slightly off due to my lack of experience using plotly

## Remarks on Reproducibility

I was able to reproduce the table and graph to look about the same as FiveThirtyEight; however, I was unable to get the correct number of rows/players in the table which results in extra data points in the graph. The article was not too clear on how they filtered for players who played in at least 70% of their teams games. I also was not able to reproduce what position was played by each player as I did not have that information and there is not available dataset on the internet that would have been easy to bring in. Overall, I had most of the information I needed and was slightly off with my figures due to either lack of data or lack of experience with the libraries. 

